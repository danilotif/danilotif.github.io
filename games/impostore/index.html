<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>L'impostore</title>
  <meta name="theme-color" content="#065f46">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü•∑</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; user-select: none; }
    body { overscroll-behavior: none; }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .card-container {
      position: relative;
      height: 220px;
      overflow: hidden;
      border-radius: 1rem;
      touch-action: none;
    }
    .card-content {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
    }
    .card-curtain {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 100%;
      background: linear-gradient(to bottom, #065f46 0%, #047857 50%, #059669 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: grab;
      transition: transform 0.4s ease-out;
      z-index: 10;
      border-radius: 1rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .card-curtain:active { cursor: grabbing; }
    .card-curtain.dragging { transition: none; }
    .drag-hint {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      color: white;
    }
    .drag-arrow {
      font-size: 2rem;
      animation: bounce 1s infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .drag-handle {
      width: 60px;
      height: 6px;
      background: rgba(255,255,255,0.4);
      border-radius: 3px;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-900 via-emerald-800 to-teal-900">
  <div id="app" class="p-4 flex items-center justify-center min-h-screen">
    <div id="game" class="w-full max-w-md"></div>
  </div>

<script>
let CATEGORIES = {};
let state = {
  phase: 'loading',
  playerCount: 4,
  chameleonIndex: null,
  secretWord: '',
  currentPlayerIndex: 0,
  revealedPlayers: new Set(),
  gameStarted: false
};

// Load categories from JSON
fetch('categories.json')
  .then(r => r.json())
  .then(data => {
    CATEGORIES = data;
    state.phase = 'setup';
    render();
  })
  .catch(err => {
    document.getElementById('game').innerHTML = `
      <div class="bg-red-500/20 rounded-xl p-6 text-center">
        <div class="text-4xl mb-4">‚ùå</div>
        <p class="text-white">Errore: impossibile caricare categories.json</p>
        <p class="text-red-200 text-sm mt-2">${err.message}</p>
      </div>`;
  });

function render() {
  const game = document.getElementById('game');
  game.innerHTML = getPhaseHTML();
  game.querySelector('.fade-in')?.classList.add('fade-in');

  // Initialize drag functionality if we're in reveal phase
  if (state.phase === 'reveal') {
    initDragReveal();
  }
}

function getPhaseHTML() {
  switch(state.phase) {
    case 'loading': return loadingHTML();
    case 'setup': return setupHTML();
    case 'reveal': return revealHTML();
    default: return '';
  }
}

function loadingHTML() {
  return `
    <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-6 shadow-2xl border border-white/20 text-center fade-in">
      <div class="text-6xl mb-4 animate-pulse">ü•∑</div>
      <p class="text-white">Caricamento...</p>
    </div>`;
}

function setupHTML() {
  const n = state.playerCount;

  return `
    <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-6 shadow-2xl border border-white/20 fade-in">
      <div class="text-center mb-6">
        <div class="text-6xl mb-2">ü•∑</div>
        <h1 class="text-3xl font-bold text-white">L'impostore</h1>
      </div>

      <div class="mb-6">
        <p class="text-emerald-200 text-center mb-4">Quanti giocatori?</p>
        <div class="flex items-center justify-center gap-4">
          <button onclick="adjustPlayers(-1)" ${n <= 3 ? 'disabled' : ''}
            class="w-12 h-12 bg-white/20 hover:bg-white/30 disabled:opacity-30 rounded-xl text-white font-bold text-2xl transition-all">-</button>
          <div class="text-5xl font-bold text-white w-20 text-center">${n}</div>
          <button onclick="adjustPlayers(1)" ${n >= 15 ? 'disabled' : ''}
            class="w-12 h-12 bg-white/20 hover:bg-white/30 disabled:opacity-30 rounded-xl text-white font-bold text-2xl transition-all">+</button>
        </div>
      </div>

      <button onclick="startGame()"
        class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-400 hover:to-emerald-400 text-white rounded-xl font-bold text-lg transition-all shadow-lg">
        ${state.gameStarted ? 'üîÑ Nuova Parola' : 'üéÆ Inizia Partita'}
      </button>
    </div>`;
}

function revealHTML() {
  const current = state.currentPlayerIndex + 1;
  const total = state.playerCount;

  const playerDots = Array.from({length: total}, (_, i) => `
    <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
      state.revealedPlayers.has(i) ? 'bg-green-500/50 text-white' :
      i === state.currentPlayerIndex ? 'bg-yellow-500/50 text-white animate-pulse' :
      'bg-white/20 text-white/50'
    }">${i + 1}</div>
  `).join('');

  const isChameleon = state.currentPlayerIndex === state.chameleonIndex;

  return `
    <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-6 shadow-2xl border border-white/20 text-center fade-in">
      <h2 class="text-2xl font-bold text-white mb-4">Giocatore ${current}</h2>

      <div class="card-container mb-4" id="cardContainer">
        <!-- Hidden content underneath -->
        <div class="card-content ${isChameleon ? 'bg-red-500/30 border-2 border-red-400' : 'bg-green-500/30 border-2 border-green-400'}" style="border-radius: 1rem;">
          ${isChameleon ? `
            <div class="text-5xl mb-2">ü•∑</div>
            <div class="text-2xl font-bold text-white">Sei l'impostore!</div>
            <div class="text-red-200 mt-2">Non conosci la parola. Bluffa!</div>
          ` : `
            <div class="text-5xl mb-2">‚ú®</div>
            <div class="text-green-200">La parola segreta √®:</div>
            <div class="text-3xl font-bold text-white mt-2">${state.secretWord}</div>
          `}
        </div>

        <!-- Draggable curtain on top -->
        <div class="card-curtain" id="cardCurtain">
          <!--<div class="drag-handle"></div>-->
          <div class="drag-hint">
            <div class="drag-arrow">‚¨ÜÔ∏è</div>
            <div class="text-lg font-medium">Trascina per scoprire</div>
          </div>
        </div>
      </div>

      <button onclick="nextPlayer()" class="w-full py-3 bg-green-500 hover:bg-green-400 text-white rounded-xl font-bold transition-all">
        ${state.currentPlayerIndex < total - 1 ? 'Prossimo ‚Üí' : 'Fine ‚Üí'}
      </button>

      <div class="mt-4 flex flex-wrap gap-2 justify-center">${playerDots}</div>
    </div>`;
}

// Game functions
function adjustPlayers(delta) {
  const newCount = state.playerCount + delta;
  if (newCount >= 3 && newCount <= 15) {
    state.playerCount = newCount;
    render();
  }
}

function startGame() {
  const allWords = Object.values(CATEGORIES).flat();
  state.secretWord = allWords[Math.floor(Math.random() * allWords.length)];
  state.chameleonIndex = Math.floor(Math.random() * state.playerCount);
  state.currentPlayerIndex = 0;
  state.revealedPlayers = new Set();
  state.gameStarted = true;
  state.phase = 'reveal';
  render();
}

function initDragReveal() {
  const curtain = document.getElementById('cardCurtain');
  const container = document.getElementById('cardContainer');
  if (!curtain || !container) return;

  let isDragging = false;
  let startY = 0;
  let currentY = 0;
  const containerHeight = container.offsetHeight;

  function getY(e) {
    return e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
  }

  function onStart(e) {
    isDragging = true;
    startY = getY(e);
    curtain.classList.add('dragging');
    e.preventDefault();
  }

  function onMove(e) {
    if (!isDragging) return;
    const y = getY(e);
    const deltaY = startY - y; // positive when dragging up
    currentY = Math.max(0, Math.min(containerHeight, deltaY));
    curtain.style.transform = `translateY(-${currentY}px)`;

    // Mark as revealed once dragged past threshold
    if (currentY > containerHeight * 0.5) {
      state.revealedPlayers.add(state.currentPlayerIndex);
    }
    e.preventDefault();
  }

  function onEnd() {
    if (!isDragging) return;
    isDragging = false;
    curtain.classList.remove('dragging');
    // Snap back down
    curtain.style.transform = 'translateY(0)';
    currentY = 0;
  }

  // Mouse events
  curtain.addEventListener('mousedown', onStart);
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onEnd);

  // Touch events
  curtain.addEventListener('touchstart', onStart, { passive: false });
  document.addEventListener('touchmove', onMove, { passive: false });
  document.addEventListener('touchend', onEnd);
}

function nextPlayer() {
  if (state.currentPlayerIndex < state.playerCount - 1) {
    state.currentPlayerIndex++;
    render();
  } else {
    state.phase = 'setup';
    render();
  }
}
</script>
</body>
</html>