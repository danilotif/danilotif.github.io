<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ğŸ¦ L'impostore</title>
  <meta name="theme-color" content="#065f46">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¦</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior: none; }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-900 via-emerald-800 to-teal-900">
  <div id="app" class="p-4 flex items-center justify-center min-h-screen">
    <div id="game" class="w-full max-w-md"></div>
  </div>

<script>
let CATEGORIES = {};
let state = {
  phase: 'loading',
  players: [],
  chameleonIndex: null,
  secretWord: '',
  currentPlayerIndex: 0,
  showingRole: false,
  revealedPlayers: new Set(),
  gameStarted: false
};

// Load categories from JSON
fetch('categories.json')
  .then(r => r.json())
  .then(data => {
    CATEGORIES = data;
    state.phase = 'setup';
    render();
  })
  .catch(err => {
    document.getElementById('game').innerHTML = `
      <div class="bg-red-500/20 rounded-xl p-6 text-center">
        <div class="text-4xl mb-4">âŒ</div>
        <p class="text-white">Errore: impossibile caricare categories.json</p>
        <p class="text-red-200 text-sm mt-2">${err.message}</p>
      </div>`;
  });

function render() {
  const game = document.getElementById('game');
  game.innerHTML = getPhaseHTML();
  game.querySelector('.fade-in')?.classList.add('fade-in');
}

function getPhaseHTML() {
  switch(state.phase) {
    case 'loading': return loadingHTML();
    case 'setup': return setupHTML();
    case 'reveal': return revealHTML();
    default: return '';
  }
}

function loadingHTML() {
  return `
    <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-6 shadow-2xl border border-white/20 text-center fade-in">
      <div class="text-6xl mb-4 animate-pulse">ğŸ¦</div>
      <p class="text-white">Caricamento...</p>
    </div>`;
}

function setupHTML() {
  const playersList = state.players.map((p, i) => `
    <div class="flex items-center justify-between bg-white/10 rounded-xl px-4 py-2">
      <span class="text-white flex items-center gap-2">
        <span class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-sm font-bold">${i + 1}</span>
        ${p}
      </span>
      <button onclick="removePlayer(${i})" class="text-red-400 hover:text-red-300 text-xl">Ã—</button>
    </div>
  `).join('');

  return `
    <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-6 shadow-2xl border border-white/20 fade-in">
      <div class="text-center mb-6">
        <div class="text-6xl mb-2">ğŸ¦</div>
        <h1 class="text-3xl font-bold text-white">L'intruso</h1>
      </div>

      <div class="mb-4">
        <div class="flex gap-2">
          <input type="text" id="newPlayer" placeholder="Nome giocatore..." maxlength="15"
            class="flex-1 px-4 py-3 rounded-xl bg-white/20 border border-white/30 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-green-400"
            onkeypress="if(event.key==='Enter')addPlayer()">
          <button onclick="addPlayer()" ${state.players.length >= 10 ? 'disabled' : ''}
            class="px-4 py-3 bg-green-500 hover:bg-green-400 disabled:bg-gray-500 text-white rounded-xl font-bold transition-all">+</button>
        </div>
      </div>

      <div class="space-y-2 mb-6 max-h-48 overflow-y-auto">${playersList}</div>

      ${state.players.length < 3 ? '<p class="text-yellow-300 text-center text-sm mb-4">Servono almeno 3 giocatori</p>' : ''}

      <button onclick="startGame()" ${state.players.length < 3 ? 'disabled' : ''}
        class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-400 hover:to-emerald-400 disabled:from-gray-500 disabled:to-gray-600 text-white rounded-xl font-bold text-lg transition-all shadow-lg">
        ${state.gameStarted ? 'ğŸ”„ Nuova Parola' : 'ğŸ® Inizia Partita'}
      </button>
    </div>`;
}

function revealHTML() {
  const playerDots = state.players.map((p, i) => `
    <div class="px-3 py-1 rounded-full text-sm ${
      state.revealedPlayers.has(i) ? 'bg-green-500/50 text-white' :
      i === state.currentPlayerIndex ? 'bg-yellow-500/50 text-white animate-pulse' :
      'bg-white/20 text-white/50'
    }">${p}</div>
  `).join('');

  if (!state.showingRole) {
    return `
      <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-6 shadow-2xl border border-white/20 text-center fade-in">
        <h2 class="text-2xl font-bold text-white mb-6">${state.players[state.currentPlayerIndex]}, tocca per vedere il tuo ruolo</h2>
        <button onclick="handleReveal()" class="w-32 h-32 mx-auto bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center text-6xl shadow-lg hover:scale-105 transition-transform active:scale-95">ğŸ‘†</button>
        <div class="mt-6 flex flex-wrap gap-2 justify-center">${playerDots}</div>
      </div>`;
  }

  const isChameleon = state.currentPlayerIndex === state.chameleonIndex;
  return `
    <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-6 shadow-2xl border border-white/20 text-center fade-in">
      <h2 class="text-2xl font-bold text-white mb-6">${state.players[state.currentPlayerIndex]}</h2>
      
      <div class="p-6 rounded-2xl mb-4 ${isChameleon ? 'bg-red-500/30 border-2 border-red-400' : 'bg-green-500/30 border-2 border-green-400'}">
        ${isChameleon ? `
          <div class="text-5xl mb-2">ğŸ¦</div>
          <div class="text-2xl font-bold text-white">Sei l'intruso!</div>
          <div class="text-red-200 mt-2">Non conosci la parola. Bluffa!</div>
        ` : `
          <div class="text-5xl mb-2">âœ¨</div>
          <div class="text-green-200">La parola segreta Ã¨:</div>
          <div class="text-3xl font-bold text-white mt-2">${state.secretWord}</div>
        `}
      </div>

      <div class="flex gap-2">
        <button onclick="handleHide()" class="flex-1 py-3 bg-gray-600 hover:bg-gray-500 text-white rounded-xl font-bold transition-all">Nascondi</button>
        <button onclick="nextPlayer()" class="flex-1 py-3 bg-green-500 hover:bg-green-400 text-white rounded-xl font-bold transition-all">
          ${state.currentPlayerIndex < state.players.length - 1 ? 'Prossimo â†’' : 'Fine â†’'}
        </button>
      </div>

      <div class="mt-6 flex flex-wrap gap-2 justify-center">${playerDots}</div>
    </div>`;
}

// Game functions
function addPlayer() {
  const input = document.getElementById('newPlayer');
  const name = input.value.trim();
  if (name && state.players.length < 10) {
    state.players.push(name);
    input.value = '';
    render();
  }
}

function removePlayer(i) {
  state.players.splice(i, 1);
  render();
}

function startGame() {
  const allWords = Object.values(CATEGORIES).flat();
  state.secretWord = allWords[Math.floor(Math.random() * allWords.length)];
  state.chameleonIndex = Math.floor(Math.random() * state.players.length);
  state.currentPlayerIndex = 0;
  state.showingRole = false;
  state.revealedPlayers = new Set();
  state.gameStarted = true;
  state.phase = 'reveal';
  render();
}

function handleReveal() {
  state.showingRole = true;
  state.revealedPlayers.add(state.currentPlayerIndex);
  render();
}

function handleHide() { 
  state.showingRole = false; 
  render(); 
}

function nextPlayer() {
  state.showingRole = false;
  if (state.currentPlayerIndex < state.players.length - 1) {
    state.currentPlayerIndex++;
    render();
  } else {
    state.phase = 'setup';
    render();
  }
}
</script>
</body>
</html>